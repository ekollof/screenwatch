#!/bin/bash
#
# Example wrapper script for screenwatch
# This script sets up the environment and runs autorandr
# Copy to ~/.local/bin/screenwatch-handler.sh and make executable
#

# Set up logging
LOG_FILE="$HOME/.local/share/screenwatch/screenwatch-handler.log"
mkdir -p "$(dirname "$LOG_FILE")"

log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $*" >> "$LOG_FILE"
}

log "=== Screen change detected ==="

# Get the actual user's UID
USER_UID=$(id -u)
USER_NAME=$(id -un)

# Detect X11 DISPLAY by checking active sockets owned by the user
detect_x11_display() {
    # Find X11 sockets owned by the user
    for socket in /tmp/.X11-unix/X*; do
        [ -S "$socket" ] || continue
        
        # Check if socket is owned by our user
        if [ "$(stat -c '%U' "$socket" 2>/dev/null)" = "$USER_NAME" ]; then
            display=":${socket##*X}"
            log "Found X11 socket for DISPLAY=$display"
            export DISPLAY="$display"
            return 0
        fi
    done
    
    # Fallback: check Xorg command line
    local xorg_display=$(pgrep -u "$USER_UID" -a Xorg | grep -oP ':\d+' | head -n1)
    if [ -n "$xorg_display" ]; then
        log "Found DISPLAY=$xorg_display from Xorg command line"
        export DISPLAY="$xorg_display"
        return 0
    fi
    
    return 1
}

# Detect Wayland display
detect_wayland_display() {
    # Check common Wayland socket locations
    for socket in "$XDG_RUNTIME_DIR"/wayland-* /run/user/"$USER_UID"/wayland-*; do
        if [ -S "$socket" ]; then
            wayland_display=$(basename "$socket")
            log "Found Wayland socket: $wayland_display"
            export WAYLAND_DISPLAY="$wayland_display"
            return 0
        fi
    done
    return 1
}

# Import XAUTHORITY from a running process
import_xauthority() {
    for proc in dwm i3 gnome-shell plasmashell xfce4-session Xorg; do
        pid=$(pgrep -u "$USER_UID" "$proc" | head -n1)
        if [ -n "$pid" ]; then
            while IFS='=' read -r -d '' key value; do
                if [ "$key" = "XAUTHORITY" ]; then
                    export XAUTHORITY="$value"
                    log "Imported XAUTHORITY=$value from $proc"
                    return 0
                fi
            done < /proc/"$pid"/environ
        fi
    done
    return 1
}

# Detect display and set up environment
if ! detect_wayland_display; then
    if ! detect_x11_display; then
        log "ERROR: Could not detect X11 or Wayland display"
    fi
fi

# Import or set XAUTHORITY
if [ -z "$XAUTHORITY" ]; then
    if ! import_xauthority; then
        export XAUTHORITY="$HOME/.Xauthority"
        log "Using default XAUTHORITY=$XAUTHORITY"
    fi
fi

# Check if DISPLAY is still not set
if [ -z "$DISPLAY" ] && [ -z "$WAYLAND_DISPLAY" ]; then
    log "ERROR: No DISPLAY or WAYLAND_DISPLAY found, cannot configure screens"
    exit 1
fi

log "Using DISPLAY=$DISPLAY XAUTHORITY=$XAUTHORITY"

# Wait for displays to stabilize (removed - now handled by screenwatch itself)
# The screenwatch service now waits for displays to be ready in udev

# Run autorandr
log "Running autorandr -c"
if autorandr -c >> "$LOG_FILE" 2>&1; then
    log "autorandr completed successfully"
else
    log "ERROR: autorandr failed with exit code $?"
fi

# Optional: Add other commands here
# For example, restart your compositor, fix wallpaper, etc.
# Example:
# if command -v feh &> /dev/null; then
#     feh --bg-scale ~/wallpaper.jpg >> "$LOG_FILE" 2>&1
#     log "Wallpaper restored"
# fi

log "Handler completed"
