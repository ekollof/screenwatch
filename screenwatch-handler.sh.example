#!/bin/bash
#
# Example wrapper script for screenwatch
# This script sets up the environment and runs autorandr
# Copy to ~/.local/bin/screenwatch-handler.sh and make executable
#

# Set up logging
LOG_FILE="$HOME/.local/share/screenwatch/screenwatch-handler.log"
mkdir -p "$(dirname "$LOG_FILE")"

log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $*" >> "$LOG_FILE"
}

log "=== Screen change detected ==="

# Get the actual user's UID
USER_UID=$(id -u)

# Import environment from a running user process (like your window manager)
# This gets the real DISPLAY and XAUTHORITY from your session
import_env_from_process() {
    # Find a process that has the environment we need
    # Try common X11/Wayland processes
    for proc in dwm i3 sway gnome-shell plasmashell xfce4-session Xorg; do
        pid=$(pgrep -u "$USER_UID" "$proc" | head -n1)
        if [ -n "$pid" ]; then
            log "Importing environment from $proc (PID: $pid)"
            
            # Extract DISPLAY and XAUTHORITY from the process environment
            while IFS='=' read -r -d '' key value; do
                case "$key" in
                    DISPLAY|XAUTHORITY|WAYLAND_DISPLAY)
                        export "$key=$value"
                        log "Imported $key=$value"
                        ;;
                esac
            done < /proc/"$pid"/environ
            
            return 0
        fi
    done
    return 1
}

# Try to import environment from running session
if ! import_env_from_process; then
    log "WARNING: Could not find running X/Wayland session, trying defaults"
    
    # Fallback: try to detect the display
    for display in :0 :1 :2; do
        if [ -S "/tmp/.X11-unix/X${display#:}" ]; then
            export DISPLAY="$display"
            log "Set DISPLAY to $DISPLAY (detected)"
            break
        fi
    done
    
    # Set XAUTHORITY if not set
    if [ -z "$XAUTHORITY" ]; then
        export XAUTHORITY="$HOME/.Xauthority"
        log "Set XAUTHORITY to $XAUTHORITY (default)"
    fi
fi

# Check if DISPLAY is still not set
if [ -z "$DISPLAY" ] && [ -z "$WAYLAND_DISPLAY" ]; then
    log "ERROR: No DISPLAY or WAYLAND_DISPLAY found, cannot configure screens"
    exit 1
fi

log "Using DISPLAY=$DISPLAY XAUTHORITY=$XAUTHORITY"

# Wait for displays to stabilize (removed - now handled by screenwatch itself)
# The screenwatch service now waits for displays to be ready in udev

# Run autorandr
log "Running autorandr -c"
if autorandr -c >> "$LOG_FILE" 2>&1; then
    log "autorandr completed successfully"
else
    log "ERROR: autorandr failed with exit code $?"
fi

# Optional: Add other commands here
# For example, restart your compositor, fix wallpaper, etc.
# Example:
# if command -v feh &> /dev/null; then
#     feh --bg-scale ~/wallpaper.jpg >> "$LOG_FILE" 2>&1
#     log "Wallpaper restored"
# fi

log "Handler completed"
