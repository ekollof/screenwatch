#!/bin/bash
#
# Example wrapper script for screenwatch
# This script sets up the environment and runs autorandr
# Copy to ~/.local/bin/screenwatch-handler.sh and make executable
#

# Set up logging
LOG_FILE="$HOME/.local/share/screenwatch/screenwatch-handler.log"
mkdir -p "$(dirname "$LOG_FILE")"

log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $*" >> "$LOG_FILE"
}

log "=== Screen change detected ==="

# Get the actual user's UID
USER_UID=$(id -u)

# Import display-related environment variables from a running WM/compositor process.
#
# X11 sockets in /tmp/.X11-unix/ are frequently owned by root (created by the display
# manager), so checking socket ownership is unreliable. Instead we read DISPLAY,
# XAUTHORITY, and WAYLAND_DISPLAY directly from the environment of a known running
# window manager or compositor process via /proc/<pid>/environ.
#
# Add your own WM/compositor to the list if it is not already present.
import_display_env() {
    local wm_procs="awm dwm i3 openbox fluxbox bspwm herbstluftwm xmonad
                    sway hyprland wayfire river labwc
                    mutter gnome-shell plasmashell kwin_x11 kwin_wayland
                    xfce4-session lxsession Xorg"

    for proc in $wm_procs; do
        local pid
        pid=$(pgrep -u "$USER_UID" -x "$proc" 2>/dev/null | head -n1)
        [ -n "$pid" ] || continue

        log "Reading environment from $proc (pid $pid)"

        # Parse the NUL-delimited environ file in a single pass
        local found_display=0 found_xauth=0 found_wayland=0
        while IFS='=' read -r -d '' key value; do
            case "$key" in
                DISPLAY)
                    if [ -z "$DISPLAY" ]; then
                        export DISPLAY="$value"
                        log "  Imported DISPLAY=$value"
                        found_display=1
                    fi
                    ;;
                XAUTHORITY)
                    if [ -z "$XAUTHORITY" ]; then
                        export XAUTHORITY="$value"
                        log "  Imported XAUTHORITY=$value"
                        found_xauth=1
                    fi
                    ;;
                WAYLAND_DISPLAY)
                    if [ -z "$WAYLAND_DISPLAY" ]; then
                        export WAYLAND_DISPLAY="$value"
                        log "  Imported WAYLAND_DISPLAY=$value"
                        found_wayland=1
                    fi
                    ;;
            esac
        done < /proc/"$pid"/environ

        # Return as soon as we have enough to proceed
        if [ $found_display -eq 1 ] || [ $found_wayland -eq 1 ]; then
            return 0
        fi
    done

    return 1
}

# Fallback: detect Wayland socket directly from the runtime directory
detect_wayland_fallback() {
    local runtime_dir="${XDG_RUNTIME_DIR:-/run/user/$USER_UID}"
    for socket in "$runtime_dir"/wayland-*; do
        if [ -S "$socket" ]; then
            export WAYLAND_DISPLAY="$(basename "$socket")"
            log "Fallback: found Wayland socket $WAYLAND_DISPLAY"
            return 0
        fi
    done
    return 1
}

# --- Set up display environment ---

# Only probe if the vars are not already set (e.g. PassEnvironment worked)
if [ -z "$DISPLAY" ] && [ -z "$WAYLAND_DISPLAY" ]; then
    if ! import_display_env; then
        log "WM process scan found nothing; trying Wayland socket fallback"
        if ! detect_wayland_fallback; then
            log "WARNING: Could not detect display from any source"
        fi
    fi
fi

# XAUTHORITY fallback: use ~/.Xauthority if still unset
if [ -z "$XAUTHORITY" ] && [ -n "$DISPLAY" ]; then
    export XAUTHORITY="$HOME/.Xauthority"
    log "XAUTHORITY not found in WM environment; using default $XAUTHORITY"
fi

# Bail out if we have neither an X11 nor a Wayland display
if [ -z "$DISPLAY" ] && [ -z "$WAYLAND_DISPLAY" ]; then
    log "ERROR: No DISPLAY or WAYLAND_DISPLAY found, cannot configure screens"
    exit 1
fi

log "Using DISPLAY=${DISPLAY:-<unset>} WAYLAND_DISPLAY=${WAYLAND_DISPLAY:-<unset>} XAUTHORITY=${XAUTHORITY:-<unset>}"

# Run autorandr
# (display-ready waiting is handled by screenwatch itself before invoking this script)
log "Running autorandr -c"
if autorandr -c >> "$LOG_FILE" 2>&1; then
    log "autorandr completed successfully"
else
    log "ERROR: autorandr failed with exit code $?"
fi

# Optional: Add other commands here
# For example, restart your compositor, fix wallpaper, etc.
# Example:
# if command -v feh &> /dev/null; then
#     feh --bg-scale ~/wallpaper.jpg >> "$LOG_FILE" 2>&1
#     log "Wallpaper restored"
# fi

log "Handler completed"
